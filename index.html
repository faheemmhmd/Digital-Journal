<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Journal</title>
    <link rel="icon" type="image/png" href="Gemini_Generated_Image_uavgoeuavgoeuavg.png">
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .slider-container {
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .slider-item { scroll-snap-align: start; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #image-upload-input, .goal-delete-btn, .goal-menu { display: none; }
        .delete-mode .goal-delete-btn { display: inline-block; }

        /* Hide slider arrows on touch devices */
        @media (hover: none) {
            #slide-left, #slide-right {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-white dark:bg-gray-800 flex flex-col items-center justify-center z-50 transition-opacity duration-500 ease-in-out">
        <img src="Gemini_Generated_Image_uavgoeuavgoeuavg.png" alt="App Icon" class="w-32 h-32 mb-4 rounded-2xl shadow-lg">
        <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Digital Journal</h1>
        <p class="text-gray-500 dark:text-gray-400">Loading your thoughts...</p>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="opacity-0 w-full max-w-sm lg:max-w-6xl mx-auto bg-white dark:bg-gray-800 lg:bg-transparent rounded-3xl lg:rounded-none shadow-lg lg:shadow-none p-5 pt-12 lg:p-8 lg:mt-8 space-y-6 lg:space-y-0 lg:grid lg:grid-cols-5 lg:gap-8 transition-opacity duration-500 ease-in-out">
        
        <!-- Left Column (Calendar) -->
        <div class="lg:col-span-3 lg:bg-white lg:dark:bg-gray-800 lg:rounded-3xl lg:shadow-lg lg:p-6">
            <header class="flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-800 dark:text-gray-200">Digital Journal</h1>
                <div id="year-display" class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold px-4 py-2 rounded-xl transition-colors duration-300">2025</div>
            </header>

            <section class="mt-6">
                <div class="flex justify-end items-center mb-2 space-x-2">
                    <button id="dense-view-btn" class="p-2 rounded-lg transition-colors text-gray-400 dark:text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg></button>
                    <button id="single-view-btn" class="p-2 rounded-lg transition-colors text-gray-400 dark:text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></button>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <div id="month-header-container" class="flex-grow text-center"></div>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                </div>
                <div id="calendar-container" class="overflow-hidden"><div id="calendar-grid" class="transition-transform duration-300 ease-in-out"></div></div>
            </section>
        </div>

        <!-- Right Column (Goals & Charts) -->
        <div class="lg:col-span-2 space-y-6">
             <section class="lg:bg-white lg:dark:bg-gray-800 lg:rounded-3xl lg:shadow-lg lg:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Goals</h3>
                    <div class="flex items-center space-x-3">
                        <button id="slide-left" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                        <div id="slider-dots" class="flex space-x-2"></div>
                        <button id="slide-right" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                    </div>
                    <button id="add-goal-category-btn" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg></button>
                </div>
                <div id="slider-container" class="slider-container flex overflow-x-auto snap-x snap-mandatory no-scrollbar rounded-xl">
                    <!-- Goal cards will be dynamically inserted here -->
                </div>
            </section>

            <section class="bg-gray-100 dark:bg-gray-800 lg:bg-white lg:dark:bg-gray-800 rounded-3xl shadow-lg p-5 lg:p-6">
                 <h3 class="font-semibold text-gray-800 dark:text-gray-200 mb-4">Progress Charts</h3>
                <div id="charts-grid" class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Charts will be dynamically inserted here -->
                </div>
            </section>
        </div>
    </div>

    <!-- Journal Page Container (Initially Hidden) -->
    <div id="journal-page-container" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 lg:p-12">
        <div id="journal-card" class="w-full h-full max-w-sm lg:max-w-none lg:w-full lg:h-full bg-white dark:bg-gray-800 rounded-3xl shadow-lg p-5 flex flex-col">
            <!-- Header -->
            <header class="flex-shrink-0 flex justify-between items-center">
                <button id="back-to-main-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h1 id="journal-date-header" class="text-lg font-bold text-gray-800 dark:text-gray-200"></h1>
                <div class="w-10"></div>
            </header>

            <!-- Main Content Area -->
            <div class="flex-grow flex flex-col lg:grid lg:grid-cols-2 lg:gap-8 mt-4 overflow-hidden">
                <!-- Image Column (Order 1 on mobile, Order 2 on desktop) -->
                <div class="h-48 lg:h-full lg:order-last">
                    <label for="image-upload-input" class="cursor-pointer block bg-gray-100 dark:bg-gray-700 rounded-xl w-full h-full overflow-hidden">
                        <div id="image-collage-container" class="w-full h-full">
                           <!-- Placeholder managed by JS -->
                        </div>
                    </label>
                    <input type="file" id="image-upload-input" accept="image/*" multiple>
                </div>

                <!-- Text Column (Order 2 on mobile, Order 1 on desktop) -->
                <div class="flex flex-col flex-grow lg:order-first mt-4 lg:mt-0">
                    <section class="flex-grow">
                        <textarea id="journal-textarea" class="w-full h-full p-4 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded-xl focus:ring-2 focus:ring-blue-400 focus:outline-none" placeholder="Start writing your thoughts for the day..."></textarea>
                    </section>
                    <section class="mt-4">
                        <button id="save-entry-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-xl hover:bg-blue-700 transition-all">Save Entry</button>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Adding Goals/Categories -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white dark:bg-gray-800 dark:border-gray-700">
            <div class="mt-3 text-center">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-200"></h3>
                <div class="mt-2 px-7 py-3">
                    <input type="text" id="modal-input" class="w-full px-3 py-2 text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border rounded-lg focus:outline-none" placeholder="...">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-save" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">Save</button>
                    <button id="modal-cancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300 mt-2">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DATA STORAGE & DEFAULTS ---
            const COLOR_PALETTE = [
                { bg: 'bg-blue-50', text: 'text-blue-800', hover: 'hover:bg-blue-200', dark_bg: 'dark:bg-blue-900/50', dark_text: 'dark:text-blue-300', dark_hover: 'dark:hover:bg-blue-800/50' },
                { bg: 'bg-purple-50', text: 'text-purple-800', hover: 'hover:bg-purple-200', dark_bg: 'dark:bg-purple-900/50', dark_text: 'dark:text-purple-300', dark_hover: 'dark:hover:bg-purple-800/50' },
                { bg: 'bg-green-50', text: 'text-green-800', hover: 'hover:bg-green-200', dark_bg: 'dark:bg-green-900/50', dark_text: 'dark:text-green-300', dark_hover: 'dark:hover:bg-green-800/50' },
                { bg: 'bg-yellow-50', text: 'text-yellow-800', hover: 'hover:bg-yellow-200', dark_bg: 'dark:bg-yellow-900/50', dark_text: 'dark:text-yellow-300', dark_hover: 'dark:hover:bg-yellow-800/50' },
                { bg: 'bg-pink-50', text: 'text-pink-800', hover: 'hover:bg-pink-200', dark_bg: 'dark:bg-pink-900/50', dark_text: 'dark:text-pink-300', dark_hover: 'dark:hover:bg-pink-800/50' },
                { bg: 'bg-indigo-50', text: 'text-indigo-800', hover: 'hover:bg-indigo-200', dark_bg: 'dark:bg-indigo-900/50', dark_text: 'dark:text-indigo-300', dark_hover: 'dark:hover:bg-indigo-800/50' },
            ];

            const getStoredData = (key, defaultValue) => JSON.parse(localStorage.getItem(key)) || defaultValue;
            const saveStoredData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
            const getEntries = () => getStoredData('journalEntries', {});
            const saveEntry = (dateKey, entry) => {
                const entries = getEntries();
                entries[dateKey] = entry;
                saveStoredData('journalEntries', entries);
            };

            // --- PAGE & MODAL ELEMENTS ---
            const appContainer = document.getElementById('app-container');
            const journalPageContainer = document.getElementById('journal-page-container');
            const modal = document.getElementById('modal');
            let currentEditingDateKey = null;

            // --- NAVIGATION ---
            const showJournalPage = (dateKey, dateString) => {
                currentEditingDateKey = dateKey;
                document.getElementById('journal-date-header').textContent = dateString;
                const entries = getEntries();
                const existingEntry = entries[dateKey];
                document.getElementById('journal-textarea').value = existingEntry?.text || '';
                renderCollage(existingEntry?.images || []);
                journalPageContainer.classList.remove('hidden');
            };

            const showMainPage = () => {
                journalPageContainer.classList.add('hidden');
                renderCalendar();
                renderAllCharts();
            };
            document.getElementById('back-to-main-btn').addEventListener('click', showMainPage);
            journalPageContainer.addEventListener('click', (e) => {
                if (e.target === journalPageContainer) {
                    showMainPage();
                }
            });

            // --- JOURNAL PAGE LOGIC ---
            const imageUploadInput = document.getElementById('image-upload-input');
            const imageCollageContainer = document.getElementById('image-collage-container');
            const imagePlaceholderHTML = '<div id="image-placeholder" class="flex items-center justify-center h-full text-gray-400 dark:text-gray-500">Click to upload images</div>';
            
            const renderCollage = (images) => {
                imageCollageContainer.innerHTML = '';
                if (!images || images.length === 0) {
                    imageCollageContainer.innerHTML = imagePlaceholderHTML;
                    return;
                }

                imageCollageContainer.className = 'w-full h-full grid gap-1';
                let gridClasses = '';
                if (images.length === 1) gridClasses = 'grid-cols-1 grid-rows-1';
                else if (images.length === 2) gridClasses = 'grid-cols-2 grid-rows-1';
                else if (images.length === 3) gridClasses = 'grid-cols-2 grid-rows-2';
                else gridClasses = 'grid-cols-2 grid-rows-2';
                imageCollageContainer.classList.add(...gridClasses.split(' '));

                images.forEach((src, index) => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.className = 'w-full h-full';

                    if (images.length === 1) {
                        img.classList.add('object-contain');
                    } else {
                        img.classList.add('object-cover');
                    }

                    if (images.length === 3 && index === 0) {
                        img.classList.add('row-span-2');
                    }
                    imageCollageContainer.appendChild(img);
                });
            };

            imageUploadInput.addEventListener('change', (event) => {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;

                const existingImages = Array.from(imageCollageContainer.querySelectorAll('img')).map(img => img.src);
                
                const filePromises = files.map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                });

                Promise.all(filePromises).then(newImages => {
                    renderCollage([...existingImages, ...newImages]);
                });
            });

            document.getElementById('save-entry-btn').addEventListener('click', () => {
                const saveBtn = document.getElementById('save-entry-btn');
                const images = Array.from(imageCollageContainer.querySelectorAll('img')).map(img => img.src);
                const entry = {
                    text: document.getElementById('journal-textarea').value,
                    images: images
                };
                saveEntry(currentEditingDateKey, entry);
                saveBtn.textContent = 'Saved!';
                setTimeout(() => { saveBtn.textContent = 'Save Entry'; }, 2000);
            });
            
            // --- CALENDAR LOGIC ---
            let currentCalendarView = 'dense'; // Default to dense view
            const singleViewBtn = document.getElementById('single-view-btn');
            const denseViewBtn = document.getElementById('dense-view-btn');
            const monthHeaderContainer = document.getElementById('month-header-container');
            const calendarGrid = document.getElementById('calendar-grid');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const yearDisplay = document.getElementById('year-display');
            let currentDate = new Date(); // Start at the actual current date
            currentDate.setFullYear(2025); // For demonstration, lock to 2025

            const updateViewSwitcher = () => {
                const isSingle = currentCalendarView === 'single';
                singleViewBtn.classList.toggle('bg-blue-100', isSingle);
                singleViewBtn.classList.toggle('text-blue-600', isSingle);
                singleViewBtn.classList.toggle('text-gray-400', !isSingle);
                denseViewBtn.classList.toggle('bg-blue-100', !isSingle);
                denseViewBtn.classList.toggle('text-blue-600', !isSingle);
                denseViewBtn.classList.toggle('text-gray-400', isSingle);
                renderCalendar();
            };
            
            const renderMonthHeader = () => {
                monthHeaderContainer.innerHTML = '';
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                if(currentCalendarView === 'dense') {
                    const header = document.createElement('h2');
                    header.textContent = `${currentDate.toLocaleString('default', { month: 'long' })}`;
                    header.className = 'text-lg font-bold text-blue-600';
                    monthHeaderContainer.appendChild(header);
                } else { // Single View
                    const monthNames = [-1, 0, 1].map(offset => new Date(year, month + offset).toLocaleString('default', { month: 'short' }));
                    monthHeaderContainer.innerHTML = `<div class="flex justify-center items-center space-x-4"><span class="text-gray-400 font-semibold">${monthNames[0]}</span><span class="text-blue-600 font-bold text-lg">${monthNames[1]}</span><span class="text-gray-400 font-semibold">${monthNames[2]}</span></div>`;
                }
            }

            const renderCalendar = () => {
                calendarGrid.innerHTML = '';
                const year = currentDate.getFullYear();
                yearDisplay.textContent = year;
                yearDisplay.classList.toggle('bg-blue-100', year === new Date().getFullYear());
                yearDisplay.classList.toggle('text-blue-600', year === new Date().getFullYear());
                yearDisplay.classList.toggle('font-bold', year === new Date().getFullYear());
                yearDisplay.classList.toggle('bg-gray-100', year !== new Date().getFullYear());
                yearDisplay.classList.toggle('text-gray-800', year !== new Date().getFullYear());

                renderMonthHeader();

                const isDesktop = window.innerWidth >= 1024;
                
                if (currentCalendarView === 'single') {
                    if (isDesktop) {
                        calendarGrid.className = 'grid grid-cols-2 gap-4';
                        const monthsToRender = 4;
                        for (let i = 0; i < monthsToRender; i++) {
                            renderMonthGrid(currentDate.getMonth() + i, true, true);
                        }
                    } else {
                        calendarGrid.className = 'grid grid-cols-7 gap-1';
                        renderMonthGrid(currentDate.getMonth(), false);
                    }
                } else { // Dense View
                    calendarGrid.className = `grid gap-2 ${isDesktop ? 'grid-cols-3' : 'grid-cols-3'}`;
                    const monthsToRender = isDesktop ? 6 : 3;
                    const offsets = Array.from({length: monthsToRender}, (_, i) => i - Math.floor((monthsToRender - 1) / 2));
                    offsets.forEach(offset => renderMonthGrid(currentDate.getMonth() + offset, true));
                }
            };
            
            const renderMonthGrid = (monthIndex, isDense = false, isSingleDesktop = false) => {
                const year = currentDate.getFullYear();
                const monthDate = new Date(year, monthIndex, 1);
                const month = monthDate.getMonth();
                const actualYear = monthDate.getFullYear();
                const monthName = monthDate.toLocaleString('default', { month: 'long' });

                const container = document.createElement('div');
                let grid;
                
                if(isDense || isSingleDesktop) {
                    container.className = 'w-full';
                    const nameEl = document.createElement('p');
                    nameEl.textContent = isSingleDesktop ? monthName : monthName.substring(0, 3).toUpperCase();
                    nameEl.className = `text-center font-semibold text-xs mb-2 ${month === currentDate.getMonth() && actualYear === currentDate.getFullYear() ? 'text-blue-600' : 'text-gray-500 dark:text-gray-400'}`;
                    container.appendChild(nameEl);
                    grid = document.createElement('div');
                    grid.className = 'grid grid-cols-7 gap-px';
                    container.appendChild(grid);
                } else {
                    grid = calendarGrid;
                }
                
                const firstDayOfMonth = new Date(actualYear, month, 1).getDay();
                const daysInMonth = new Date(actualYear, month + 1, 0).getDate();
                const entries = getEntries();

                for (let i = 0; i < firstDayOfMonth; i++) grid.insertAdjacentHTML('beforeend', '<div></div>');

                for (let day = 1; day <= daysInMonth; day++) {
                    const daySquare = document.createElement('div');
                    const dateKey = `${actualYear}-${month}-${day}`;
                    
                    if(isDense && !isSingleDesktop) {
                        daySquare.className = 'w-full aspect-square rounded-sm cursor-pointer';
                    } else {
                        daySquare.textContent = day;
                        daySquare.className = 'w-full aspect-square rounded-md cursor-pointer flex items-center justify-center text-sm';
                    }
                    
                    if (entries[dateKey]?.text) {
                        daySquare.classList.add('bg-blue-400', 'text-white');
                    } else {
                        daySquare.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
                    }
                    
                    daySquare.addEventListener('click', () => showJournalPage(dateKey, `${monthName} ${day}, ${actualYear}`));
                    grid.appendChild(daySquare);
                }
                if(isDense || isSingleDesktop) calendarGrid.appendChild(container);
            };
            
            singleViewBtn.addEventListener('click', () => { currentCalendarView = 'single'; updateViewSwitcher(); });
            denseViewBtn.addEventListener('click', () => { currentCalendarView = 'dense'; updateViewSwitcher(); });
            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });

            // --- GOALS LOGIC ---
            const sliderContainer = document.getElementById('slider-container');
            const sliderDotsContainer = document.getElementById('slider-dots');
            let currentSlide = 0;
            
            const renderGoalSliders = () => {
                sliderContainer.innerHTML = '';
                sliderDotsContainer.innerHTML = '';
                let goalCategories = getStoredData('goalCategories', null);
                
                if (goalCategories === null) {
                    goalCategories = [
                        { title: 'Daily Goals', goals: [], color: COLOR_PALETTE[0] },
                        { title: 'Work', goals: [], color: COLOR_PALETTE[1] },
                        { title: 'Personal', goals: [], color: COLOR_PALETTE[2] }
                    ];
                    saveStoredData('goalCategories', goalCategories);
                }

                goalCategories.forEach((category, categoryIndex) => {
                    const color = category.color || COLOR_PALETTE[0];
                    const card = document.createElement('div');
                    card.className = `slider-item flex-shrink-0 w-full p-5 ${color.bg} ${color.dark_bg} rounded-xl`;
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold ${color.text} ${color.dark_text}">${category.title}</h3>
                            <div class="relative">
                                <button data-menu-index="${categoryIndex}" class="goal-menu-btn p-1 rounded-full ${color.hover} ${color.dark_hover}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${color.text} ${color.dark_text}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01" /></svg></button>
                                <div id="goal-menu-${categoryIndex}" class="goal-menu absolute right-0 mt-2 w-40 bg-white dark:bg-gray-700 rounded-lg shadow-xl z-10">
                                    <a href="#" data-action="add" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Add Goal</a>
                                    <a href="#" data-action="delete" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Toggle Delete</a>
                                    ${categoryIndex > 0 ? `<a href="#" data-action="delete-category" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600">Delete Category</a>` : ''}
                                </div>
                            </div>
                        </div>
                        <div id="goal-list-${categoryIndex}" class="space-y-3 mb-3 min-h-[8.5rem]"></div>
                    `;
                    sliderContainer.appendChild(card);
                    renderGoals(categoryIndex);

                    const dot = document.createElement('div');
                    dot.className = 'w-2 h-2 rounded-full cursor-pointer transition-colors';
                    sliderDotsContainer.appendChild(dot);
                });
                updateSliderDots();
            };

            const renderGoals = (categoryIndex) => {
                const goalCategories = getStoredData('goalCategories', []);
                const category = goalCategories[categoryIndex];
                if (!category) return;

                const listEl = document.getElementById(`goal-list-${categoryIndex}`);
                listEl.innerHTML = '';

                category.goals.forEach((goal, goalIndex) => {
                    const goalEl = document.createElement('div');
                    goalEl.className = 'flex items-center justify-between';
                    goalEl.innerHTML = `
                        <div class="flex items-center flex-grow mr-2">
                            <input type="checkbox" id="goal-${categoryIndex}-${goalIndex}" class="h-5 w-5 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500" ${goal.checked ? 'checked' : ''}>
                            <label for="goal-${categoryIndex}-${goalIndex}" class="ml-3 text-gray-700 dark:text-gray-300 ${goal.checked ? 'line-through' : ''}">${goal.text}</label>
                        </div>
                        <button data-goal-index="${goalIndex}" class="goal-delete-btn text-red-400 hover:text-red-600 font-bold text-xl px-2">&times;</button>
                    `;
                    listEl.appendChild(goalEl);

                    goalEl.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                        category.goals[goalIndex].checked = e.target.checked;
                        saveStoredData('goalCategories', goalCategories);
                        renderGoals(categoryIndex);
                        renderAllCharts();
                    });

                    goalEl.querySelector('.goal-delete-btn').addEventListener('click', () => {
                        category.goals.splice(goalIndex, 1);
                        saveStoredData('goalCategories', goalCategories);
                        renderGoals(categoryIndex);
                        renderAllCharts();
                    });
                });
            };

            // --- MODAL & MENU LOGIC ---
            let currentModalAction = null;
            const modalTitle = document.getElementById('modal-title');
            const modalInput = document.getElementById('modal-input');
            const modalSave = document.getElementById('modal-save');
            const modalCancel = document.getElementById('modal-cancel');
            
            const openModal = (config) => {
                modalTitle.textContent = config.title;
                modalInput.placeholder = config.placeholder;
                currentModalAction = config.onSave;
                modal.classList.remove('hidden');
                modalInput.focus();
            };

            modalSave.addEventListener('click', () => {
                if(currentModalAction) currentModalAction(modalInput.value.trim());
                modalInput.value = '';
                modal.classList.add('hidden');
            });
            modalCancel.addEventListener('click', () => modal.classList.add('hidden'));

            document.getElementById('add-goal-category-btn').addEventListener('click', () => {
                openModal({
                    title: 'Add New Goal Category',
                    placeholder: 'Category Name (e.g., Fitness)',
                    onSave: (title) => {
                        if (title) {
                            const goalCategories = getStoredData('goalCategories', []);
                            const newColor = COLOR_PALETTE[goalCategories.length % COLOR_PALETTE.length];
                            goalCategories.push({ title: title, goals: [], color: newColor });
                            saveStoredData('goalCategories', goalCategories);
                            renderGoalSliders();
                            renderAllCharts();
                        }
                    }
                });
            });

            document.body.addEventListener('click', (e) => {
                if (!e.target.closest('.goal-menu-btn')) {
                    document.querySelectorAll('.goal-menu').forEach(m => m.style.display = 'none');
                }

                const menuBtn = e.target.closest('.goal-menu-btn');
                if (menuBtn) {
                    e.stopPropagation();
                    const menuIndex = menuBtn.dataset.menuIndex;
                    const menuEl = document.getElementById(`goal-menu-${menuIndex}`);
                    const isVisible = menuEl.style.display === 'block';
                    document.querySelectorAll('.goal-menu').forEach(m => m.style.display = 'none');
                    if (!isVisible) menuEl.style.display = 'block';
                    return;
                }

                const actionLink = e.target.closest('a[data-action]');
                if (actionLink) {
                    e.preventDefault();
                    const action = actionLink.dataset.action;
                    const categoryIndex = actionLink.closest('.goal-menu').id.match(/\d+/)[0];
                    const goalCategories = getStoredData('goalCategories', []);

                    if (goalCategories[categoryIndex] && action === 'add') {
                        openModal({
                            title: `Add New Goal to "${goalCategories[categoryIndex].title}"`,
                            placeholder: 'Your goal...',
                            onSave: (text) => {
                                if (text) {
                                    goalCategories[categoryIndex].goals.push({ text, checked: false });
                                    saveStoredData('goalCategories', goalCategories);
                                    renderGoals(categoryIndex);
                                    renderAllCharts();
                                }
                            }
                        });
                    } else if (action === 'delete') {
                        document.getElementById(`goal-list-${categoryIndex}`).classList.toggle('delete-mode');
                    } else if (goalCategories[categoryIndex] && action === 'delete-category') {
                        if (confirm(`Are you sure you want to delete the "${goalCategories[categoryIndex].title}" category?`)) {
                            goalCategories.splice(categoryIndex, 1);
                            saveStoredData('goalCategories', goalCategories);
                            renderGoalSliders();
                            renderAllCharts();
                        }
                    }
                    actionLink.closest('.goal-menu').style.display = 'none';
                }
            });

            // --- CHARTS LOGIC ---
            const chartsGrid = document.getElementById('charts-grid');
            
            const renderAllCharts = () => {
                chartsGrid.innerHTML = '';
                
                const dailyGoalsCategory = getStoredData('goalCategories', []).find(c => c.title === 'Daily Goals');
                if(dailyGoalsCategory) {
                    const dailyChartContainer = document.createElement('div');
                    dailyChartContainer.className = 'flex flex-col items-center justify-start';
                    dailyChartContainer.innerHTML = `
                        <svg id="daily-goals-chart-svg" class="w-24 h-24" viewBox="0 0 36 36"></svg>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Daily Goals</p>
                    `;
                    chartsGrid.appendChild(dailyChartContainer);
                    renderGoalCompletionChart('daily-goals-chart-svg', dailyGoalsCategory.goals);
                }

                const journalChartContainer = document.createElement('div');
                journalChartContainer.className = 'flex flex-col items-center justify-start';
                journalChartContainer.innerHTML = `
                    <svg id="progress-chart-svg" class="w-full h-24" viewBox="0 0 140 100" preserveAspectRatio="xMidYMid meet"></svg>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Journaling</p>
                `;
                chartsGrid.appendChild(journalChartContainer);
                renderProgressChart();
            };

            const renderGoalCompletionChart = (svgId, goals) => {
                const chartSvg = document.getElementById(svgId);
                if (!chartSvg) return;
                const completed = goals.filter(g => g.checked).length;
                const total = goals.length;
                const percentage = total > 0 ? (completed / total) * 100 : 0;
                const strokeDasharray = `${percentage} ${100 - percentage}`;

                chartSvg.innerHTML = `
                    <circle class="text-gray-200 dark:text-gray-600" stroke-width="3" stroke="currentColor" fill="transparent" r="15.915" cx="18" cy="18" />
                    <circle class="text-blue-500" stroke-width="3" stroke-dasharray="${strokeDasharray}" stroke-dashoffset="25" stroke="currentColor" fill="transparent" r="15.915" cx="18" cy="18" />
                    <text x="18" y="18" dominant-baseline="middle" class="text-[8px] font-bold fill-current text-gray-700 dark:text-gray-300" text-anchor="middle">${Math.round(percentage)}%</text>
                `;
            };

            const renderProgressChart = () => {
                const chartSvg = document.getElementById('progress-chart-svg');
                if (!chartSvg) return;
                chartSvg.innerHTML = '';
                const entries = getEntries();
                const year = 2025;
                const entriesPerMonth = Array(12).fill(0).map((_, i) => Object.keys(entries).filter(k => k.startsWith(`${year}-${i}-`)).length);
                const maxEntries = Math.max(...entriesPerMonth, 1);
                
                const svgWidth = 140;
                const svgHeight = 100;
                const barWidth = svgWidth / 12 * 0.6;
                const spacing = svgWidth / 12 * 0.4;

                entriesPerMonth.forEach((count, index) => {
                    const barHeight = (count / maxEntries) * (svgHeight - 10);
                    const x = index * (barWidth + spacing) + (spacing / 2);
                    const y = svgHeight - barHeight;
                    
                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute('x', x);
                    rect.setAttribute('y', y);
                    rect.setAttribute('width', barWidth);
                    rect.setAttribute('height', barHeight);
                    rect.setAttribute('fill', '#3b82f6');
                    rect.setAttribute('rx', '2');
                    chartSvg.appendChild(rect);
                });
            };

            // --- SLIDER LOGIC ---
            const slideLeftBtn = document.getElementById('slide-left');
            const slideRightBtn = document.getElementById('slide-right');
            
            const updateSliderDots = () => {
                const sliderItems = document.querySelectorAll('.slider-item');
                sliderDotsContainer.innerHTML = '';
                sliderItems.forEach((_, index) => {
                    const dot = document.createElement('div');
                    dot.className = `w-2 h-2 rounded-full cursor-pointer transition-colors ${index === currentSlide ? 'bg-blue-500' : 'bg-gray-300 dark:bg-gray-600'}`;
                    dot.addEventListener('click', () => {
                        currentSlide = index;
                        updateSlider();
                    });
                    sliderDotsContainer.appendChild(dot);
                });
            };

            const updateSlider = () => {
                sliderContainer.scrollTo({ left: sliderContainer.offsetWidth * currentSlide, behavior: 'smooth' });
                updateSliderDots();
            };

            sliderContainer.addEventListener('scroll', () => {
                const slideWidth = sliderContainer.offsetWidth;
                const newSlide = Math.round(sliderContainer.scrollLeft / slideWidth);
                if (newSlide !== currentSlide) {
                    currentSlide = newSlide;
                    updateSliderDots();
                }
            });

            slideRightBtn.addEventListener('click', () => {
                const sliderItems = document.querySelectorAll('.slider-item');
                if (sliderItems.length > 0) {
                    currentSlide = (currentSlide + 1) % sliderItems.length;
                    updateSlider();
                }
            });
            slideLeftBtn.addEventListener('click', () => {
                const sliderItems = document.querySelectorAll('.slider-item');
                if (sliderItems.length > 0) {
                    currentSlide = (currentSlide - 1 + sliderItems.length) % sliderItems.length;
                    updateSlider();
                }
            });
            
            // --- THEME & NOTIFICATION LOGIC ---
            const updateTheme = () => {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            };

            const setupNotifications = () => {
                if ('Notification' in window && Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            console.log('Notification permission granted.');
                            // Schedule notifications
                            scheduleNotification(5, 0, 'Time for a new start!', 'Set your goals for the day.');
                            scheduleNotification(22, 0, 'Ready to reflect?', 'Don\'t forget to write your journal entry before bed.');
                        }
                    });
                }
            };

            const scheduleNotification = (hour, minute, title, body) => {
                const now = new Date();
                let notificationTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0, 0);

                if (now > notificationTime) {
                    notificationTime.setDate(notificationTime.getDate() + 1);
                }

                const timeUntilNotification = notificationTime.getTime() - now.getTime();
                
                setTimeout(() => {
                    new Notification(title, { body: body, icon: 'https://i.imgur.com/3b6j3fK.png' });
                    // Reschedule for the next day
                    setInterval(() => {
                        new Notification(title, { body: body, icon: 'https://i.imgur.com/3b6j3fK.png' });
                    }, 24 * 60 * 60 * 1000);
                }, timeUntilNotification);
            };

            // --- INITIALIZE APP ---
            const splashScreen = document.getElementById('splash-screen');
            setTimeout(() => {
                splashScreen.classList.add('opacity-0');
                appContainer.classList.remove('opacity-0');
                setTimeout(() => splashScreen.style.display = 'none', 500);

                window.addEventListener('resize', renderCalendar);
                updateTheme();
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateTheme);
                updateViewSwitcher();
                renderGoalSliders();
                renderAllCharts();
                setupNotifications();
            }, 1500);
        });
    </script>
</body>
</html>
